---
title: "EDA"
output: html_document
---

# Setup
## Load Packages
```{r}
library(nycflights13)
library(tidyverse)
library(ggplot2)
library(patchwork)
library(GGally)
```

## Load Datasets
```{r}
# cast to dataframe
airlines_df = as.data.frame(airlines)
airports_df = as.data.frame(airports)
flights_df = as.data.frame(flights)
planes_df = as.data.frame(planes)
weather_df = as.data.frame(weather)
```


```{r}
airlines_df
head(airports_df)
head(flights_df)
head(planes_df)
head(weather_df)
```

```{r}
# creating PK for flights
flights_df$flight_num <- paste(flights_df$carrier, flights_df$flight, sep="-")
flights_df$key <- paste(flights_df$carrier, flights_df$flight, flights_df$month, flights_df$date, sep="-")

# also need to create PK for weather
weather_df$key <- paste(weather_df$origin, weather_df$time_hour, sep="-")
```

```{r}
# keeping track of which kind of variable each column is
airlines_categorical <- c("carrier", "name")

airports_categorical <- c("faa", "name", "dst", "tzone")
airports_ratio <- c("lat", "lon", "alt", "tz")

flights_categorical <- c("carrier", "tailnum", "origin", "dest", "flight", "flight_num") # may need to cast flight to another type since currently an int
flights_time <- c("year", "month", "day", "hour", "minute", "time_hour", "dep_time", "scheduled_dep_time", "arr_time", "scheduled_arr_time") # need to figure out how to deal with these... need to convert times to actual time
flights_ratio <- c("dep_delay", "arr_delay", "air_time", "distance")

planes_categorical <- c("tailnum", "type", "manufacturer", "model", "engine")
planes_ratio <- c("year", "engines", "seats", "speed") # idk if year really goes here

weather_categorical <- c("origin")
weather_time <- c("year", "month", "day", "hour", "time_hour") # need to figure out how to deal with these
weather_ratio <- c("temp", "dewp", "humid", "wind_dir", "wind_speed", "wind_gust", "precip", "pressure")
weather_ordinal <- c("visib")
```

```{r}
unique(flights_df$origin)
unique(flights_df$dest)
```

# Data Cleaning
```{r}
# check for NA
colSums(sapply(airports_df, is.na))
colSums(sapply(flights_df, is.na))
colSums(sapply(planes_df, is.na))
colSums(sapply(weather_df, is.na))
```
There are a few columns missing a lot of values. TODO: deal with this. 

```{r}
flights_df <- flights_df%>%
  mutate(
    date = paste(month, day, sep="-"),
    cancellation = if_else(is.na(air_time), 1, 0),
    delayed_departure = dep_delay > 0,
    on_time_departure = dep_delay == 0,
    early_departure = dep_delay < 0,
    delayed_arrival = arr_delay > 0,
    on_time_arrival = arr_delay == 0,
    early_arrival = arr_delay < 0,
    departure_type = if_else(delayed_departure, "delayed", if_else(early_departure, "early", "on-time")),
    arrival_type = if_else(delayed_arrival, "delayed", if_else(early_arrival, "early", "on-time")),
    delay_difference = arr_delay - dep_delay # does having a delayed departure --> a delayed arrival?
  )

cleaned_df <- left_join(flights_df%>%subset(cancellation == 0), airlines, by="carrier")
head(cleaned_df)

colSums(sapply(cleaned_df, is.na))
```

# Summary Statistics
```{r}
# checking to see if each row can be identified uniquely
print("airlines")
length(airlines_df$carrier)
length(unique(airlines_df$carrier))

print("airports")
length(airports_df$faa)
length(unique(airports_df$faa))

print("flights")
length(cleaned_df$flight_num)
length(unique(cleaned_df$flight_num))
length(unique(cleaned_df$key))
length(unique(cleaned_df$tailnum))

print("planes")
length(planes_df$tailnum)
length(unique(planes_df$tailnum))

print("weather")
length(weather_df$key)
length(weather_df$key)
```
Length of dataframes:
airlines = 16
airports = 1,458
flights = 336,776
planes = 3,322
weather = 26,115

The number of unique tail numbers in flights do not match the number of unique tail numbers in planes, suggesting that there may be some missing records in the planes table. Additionally, the number of carrier + flight numbers in flights is much less than the table length, suggesting that this cannot be used as the primary key.

```{r}
max(flights_df$time_hour)
min(flights_df$time_hour)
```
## Numerical Summaries
```{r}
print("-----flights------")
summary(flights%>%select(all_of(flights_ratio)))
print("-----planes------")
summary(planes%>%select(all_of(planes_ratio)))
print("-----weather------")
summary(weather%>%select(all_of(weather_ratio)))
```

# Initial Visualizations

## Repeated Barplots
```{r, fig.width=16, fig.height=12}
barplot_grid <- function(df, cat_vars, color, n_col){
  cat_plots <- lapply(cat_vars, function(var) {
    ggplot(df, aes_string(x = var)) +
      geom_bar(fill = color) +
      labs(title = paste("Frequency of", var), x = var, y = "Relative Frequency") +
      theme_minimal()
  })
  
  return(wrap_plots(cat_plots, ncol = n_col))
}

barplot_grid(airports_df, airports_categorical, "steelblue", 3)
barplot_grid(flights_df, flights_categorical, "forestgreen", 3)
barplot_grid(planes_df, planes_categorical, "coral", 3)
```
The flights are relatively evenly distributed across the three airports, although EWR has the most flights and LGA has the least. The number of flights from each carrier differs, although some carriers use certain airports more often (e.g. UA and EV from EWR, 9E and B6 from JFK, MQ from LGA).

The number of flights by each plane and to each destination varies a lot.

## Repeated Boxplots
```{r, fig.width=10, fig.height=6}
boxplot_grid <- function(df, num_vars, color, n_col){
  box_plots <- lapply(num_vars, function(var) {
    ggplot(df, aes_string(x = var, y = "1")) +
      geom_boxplot(fill = color) +
      labs(title = paste("Boxplot of", var), x = NULL, y = var) +
      theme_minimal()
  })
  return(wrap_plots(box_plots, ncol = n_col))
}

boxplot_grid(airports_df, airports_ratio, "steelblue", 2)
boxplot_grid(flights_df, flights_ratio, "forestgreen", 2)
boxplot_grid(planes_df, planes_ratio, "coral", 2)
boxplot_grid(weather_df, weather_ratio, "darkorchid", 3)

boxplot(cleaned_df$delay_difference)
```

## Repeated Histograms
```{r}
hist_grid <- function(df, num_vars, color, n_col){
  hist_plots <- lapply(num_vars, function(var) {
    ggplot(df, aes_string(x = var)) +
      geom_histogram(fill = color, bins = 10) +
      labs(title = paste("Histogram of", var), x = NULL, y = var) +
      theme_minimal()
  })
  return(wrap_plots(hist_plots, ncol = n_col))
}

hist_grid(airports_df, airports_ratio, "steelblue", 2)
hist_grid(flights_df, flights_ratio, "forestgreen", 2)
hist_grid(planes_df, planes_ratio, "coral", 2)
hist_grid(weather_df, weather_ratio, "darkorchid", 3)
```
Departure delay and arrival delay are skewed. air time is bimodal

## Faceted Plots
May want to pick a specific origin, although it doesn't look like there's a meaningful difference
```{r}
ggplot(data=flights_df, aes(x=carrier, fill=origin)) + geom_bar()
ggplot(data=flights_df, aes(x=log(dep_delay), fill=origin)) + geom_boxplot()
```
## Scatterplots
```{r}
ggplot(data=flights, aes(x=dep_delay, y=arr_delay)) + geom_point() + geom_smooth()
ggplot(data=flights, aes(x=air_time, y=arr_delay)) + geom_point() + geom_smooth()
```


# Merge Dataframes

# Classifying Delay Types
**Does a delayed departure mean a delayed arrival? What percentage of flights are delayed (in departure or arrival)?** 
```{r}
table(cleaned_df$departure_type, cleaned_df$arrival_type)
table(cleaned_df$departure_type) / length(cleaned_df$departure_type)
table(cleaned_df$arrival_type) / length(cleaned_df$arrival_type)
table(cleaned_df$departure_type, cleaned_df$arrival_type) / length(cleaned_df$arrival_type)
```

**Given a flight is delayed in departing, is it more likely that the arrival will also be delayed? Is there a certain threshold when this happens?**
```{r}
ggplot(cleaned_df, aes(x = arr_delay)) + facet_grid(vars(col = departure_type)) + geom_histogram()
```

**Does this breakdown differ by airline or departure airport?**
```{r}
jfk <- cleaned_df%>%subset(origin=="JFK")
ewr <- cleaned_df%>%subset(origin=="EWR")
lga <- cleaned_df%>%subset(origin=="LGA")

print("jfk")
table(jfk$departure_type) / length(jfk$delayed_arrival)
table(jfk$arrival_type) / length(jfk$delayed_arrival)
table(jfk$departure_type, jfk$arrival_type) / length(jfk$delayed_arrival)

print("ewr")
table(ewr$departure_type) / length(ewr$delayed_arrival)
table(ewr$arrival_type) / length(ewr$delayed_arrival)
table(ewr$departure_type, ewr$arrival_type) / length(ewr$delayed_arrival)

print("lga")
table(lga$departure_type) / length(lga$delayed_arrival)
table(lga$arrival_type) / length(lga$delayed_arrival)
table(lga$departure_type, lga$arrival_type) / length(lga$delayed_arrival)
```
are these statistically significant differences??

```{r, fig.width=20, fig.height=8}
ggplot(cleaned_df, aes(x=name, fill=arrival_type)) + 
  geom_bar() + 
  labs(
    title="Arrival Status by Carrier", 
    x = "Carrier",
    y = "Count of Flights")

ggplot(cleaned_df, aes(x=origin, fill=arrival_type)) + 
  geom_bar() + 
    labs(
    title="Arrival Status by Origin", 
    x = "Origin",
    y = "Count of Flights")

ggplot(cleaned_df, aes(x=name, fill=arrival_type)) + 
  geom_bar(position="fill") +
  labs(
    title="Proportion of Arrival Status by Carrier", 
    x = "Carrier",
    y = "Proportion of Flights")

ggplot(cleaned_df, aes(x=name, y=air_time)) + geom_boxplot()
ggplot(cleaned_df, aes(x=name, y=dep_delay)) + geom_boxplot()
ggplot(cleaned_df, aes(x=name, y=arr_delay)) + geom_boxplot()
ggplot(cleaned_df, aes(x=name, y=delay_difference)) + geom_boxplot()
```
Frontier and AirTran have the most delays, proportionally. Hawaiian has the least delays. However, Frontier, Hawaiian also don't have many flights. United, Delta, ExpressJet, JetBlue have a lot of flights. Airports are relatively similar.
When facet air time by carrier, normal distributions. Some airlines have a wider range of airtimes, prob bc they go to the most places. others like Frontier/Hawaiian have a very narrow range.
Departure and arrival delays are all pretty skewed.



# Thoughts
Important response variables: arrival delay and departure delay (is there a meaningful difference between these? are they related?)
New variables:
direction (use lat and lon -- maybe slope between?)
could also combine and see what most important predictors are using dimensionality reduction technique
age of the plane -- create new variable for year manufactured

# Create New Aggregations
```{r, message=FALSE}
tailnum_agg <- cleaned_df%>%
  group_by(tailnum)%>%
  summarise(
    n_flights = n(),
    avg_dep_delay = mean(dep_delay),
    avg_arr_delay = mean(arr_delay),
    n_delayed_arrival = sum(delayed_arrival),
    perc_delay_arrival = n_delayed_arrival/n_flights
  )

ggpairs(tailnum_agg%>%select(-tailnum))
ggplot(data = tailnum_agg, aes(x=n_flights, y = perc_delay_arrival)) + geom_point(size = 0.5)
```

```{r}
# carrier summary
carrier_agg <- cleaned_df%>%
  group_by(name) %>%
  summarise(
    fleet_size = n_distinct(tailnum),
    n_flights = n(),
    n_dest = n_distinct(dest),
    n_delay_departure = sum(delayed_departure),
    n_delay_arrival = sum(delayed_arrival),
    avg_flight_time = mean(air_time),
    avg_arr_delay = mean(arr_delay),
    std_arr_delay = sd(arr_delay),
    avg_dep_delay = mean(dep_delay),
    std_dep_delay = sd(dep_delay),
    avg_delay_diff = mean(delay_difference),
    std_delay_diff = sd(delay_difference)
  ) %>%
  mutate(
    std_err_arr_delay = std_arr_delay / sqrt(n_flights),
    conf_lower_arr_delay = avg_arr_delay - qt(0.975, df = n_flights - 1) * std_err_arr_delay,
    conf_upper_arr_delay = avg_arr_delay + qt(0.975, df = n_flights - 1) * std_err_arr_delay,
    std_err_dep_delay =  std_dep_delay / sqrt(n_flights),
    conf_lower_dep_delay = avg_dep_delay - qt(0.975, df = n_flights - 1) * std_err_dep_delay,
    conf_upper_dep_delay = avg_dep_delay + qt(0.975, df = n_flights - 1) * std_err_dep_delay,
    std_err_delay_diff =  std_delay_diff / sqrt(n_flights),
    conf_lower_delay_diff = avg_delay_diff - qt(0.975, df = n_flights - 1) * std_err_delay_diff,
    conf_upper_delay_diff = avg_delay_diff + qt(0.975, df = n_flights - 1) * std_err_delay_diff
  )

carrier_agg
```

```{r, message=FALSE}
ggpairs(carrier_agg%>%
        select(c(fleet_size, n_flights, n_dest, n_delay_arrival, avg_flight_time, avg_arr_delay, avg_dep_delay, avg_delay_diff))
      )
```


```{r, fig.width=22, fig.height=8}
ggplot(carrier_agg, aes(x = reorder(name, avg_dep_delay), y = avg_dep_delay)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf_lower_dep_delay, ymax = conf_upper_dep_delay)) + 
  geom_hline(aes(yintercept = mean(cleaned_df$dep_delay)), color="turquoise", linewidth=3) +
  labs(
    title = "Confidence Intervals for Mean Departure Delay By Carrier",
    x = "Carrier",
    y = "Mean Departure Delay (Minutes)"
  )

ggplot(carrier_agg, aes(x = reorder(name, avg_arr_delay), y = avg_arr_delay)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf_lower_arr_delay, ymax = conf_upper_arr_delay)) + 
  geom_hline(aes(yintercept = mean(cleaned_df$arr_delay)), color="turquoise", linewidth=3) +
  labs(
    title = "Confidence Intervals for Mean Arrival Delay By Carrier",
    x = "Carrier",
    y = "Mean Arrival Delay (Minutes)"
  )

ggplot(carrier_agg, aes(x = reorder(name, avg_delay_diff), y = avg_delay_diff)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf_lower_delay_diff, ymax = conf_upper_delay_diff)) + 
  geom_hline(aes(yintercept = mean(cleaned_df$delay_difference)), color="turquoise", linewidth=3) +
  labs(
    title = "Confidence Intervals for Delay Difference By Carrier",
    x = "Carrier",
    y = "Difference Between Arrival Delay and Departure Delay (Minutes)"
  ) # negative values: despite a delayed departure, arrive earlier
```
Budget airlines consistently perform worse

```{r}
mega_table <- inner_join(flights, planes, by="tailnum")

head(mega_table)
```

